"use client"

import * as React from "react"
import { z } from "zod"
import { useForm } from "react-hook-form"
import { zodResolver } from "@hookform/resolvers/zod"

import { cn } from "@/lib/utils"
import { Icons } from "./icons"
import { Button } from "./button"
import { Input } from "./input"

import { LoginSchema, RegisterSchema } from "@/contexts/AuthProvider"

interface UserAuthFormState {
  isLoading: boolean
  onSuccess: (success: boolean) => void
  onFail: (error: string) => void
}

interface UserAuthFormProps extends React.HTMLAttributes<HTMLDivElement> {
  mode: "login" | "register"
  formState: UserAuthFormState
}

function UserLoginAuthForm({ formState, className, ...props }: UserAuthFormProps) {
  const form = useForm<z.infer<typeof LoginSchema>>({
    resolver: zodResolver(LoginSchema),
    defaultValues: { email: "", password: "" },
  })

  async function onSubmit(data: z.infer<typeof LoginSchema>) {
    console.log(data)
    try {
      formState.onSuccess(true)
    } catch (error: any) {
      formState.onFail(error.message || "Login failed.")
    }
  }

  return (
    <div className={cn("grid gap-6", className)} {...props}>
      <form onSubmit={form.handleSubmit(onSubmit)} className="space-y-4">
        <div className="grid gap-1">
          <Input
            id="email"
            placeholder="john.doe@example.com"
            type="email"
            autoCapitalize="none"
            autoComplete="email"
            autoCorrect="off"
            disabled={formState.isLoading}
            {...form.register("email")}
          />
          <p className="text-red-600">{form.formState.errors.email?.message}</p>
        </div>
        <div className="grid gap-1">
          <Input
            id="password"
            placeholder="Password"
            type="password"
            autoComplete="current-password"
            disabled={formState.isLoading}
            {...form.register("password")}
          />
          <p className="text-red-600">{form.formState.errors.password?.message}</p>
        </div>
        <Button disabled={formState.isLoading} className="w-full">
          {formState.isLoading && (
            <Icons.spinner className="mr-2 h-4 w-4 animate-spin" />
          )}
          Sign In with Email
        </Button>
      </form>
    </div>
  )
}

function UserRegisterAuthForm({ formState, className, ...props }: UserAuthFormProps) {
  const form = useForm<z.infer<typeof RegisterSchema>>({
    resolver: zodResolver(RegisterSchema),
    defaultValues: { email: "", password: "", confirmPassword: "" },
  })

  async function onSubmit(data: z.infer<typeof RegisterSchema>) {
    console.log(data)
    try {
      formState.onSuccess(true)
    } catch (error: any) {
      formState.onFail(error.message || "Registration failed.")
    }
  }

  return (
    <div className={cn("grid gap-6", className)} {...props}>
      <form onSubmit={form.handleSubmit(onSubmit)} className="space-y-4">
        <div className="grid gap-1">
          <Input
            id="email"
            placeholder="john.doe@example.com"
            type="email"
            autoCapitalize="none"
            autoComplete="email"
            autoCorrect="off"
            disabled={formState.isLoading}
            {...form.register("email")}
          />
          <p className="text-red-600">{form.formState.errors.email?.message}</p>
        </div>
        <div className="grid gap-1">
          <Input
            id="username"
            placeholder="Username"
            type="text"
            autoComplete="username"
            disabled={formState.isLoading}
            {...form.register("username")}
          />
        </div>
        <div className="grid gap-1">
          <Input
            id="password"
            placeholder="Password"
            type="password"
            autoComplete="new-password"
            disabled={formState.isLoading}
            {...form.register("password")}
          />
          <p className="text-red-600">{form.formState.errors.password?.message}</p>
        </div>
        <div className="grid gap-1">
          <Input
            id="confirmPassword"
            placeholder="Confirm Password"
            type="password"
            autoComplete="new-password"
            disabled={formState.isLoading}
            {...form.register("confirmPassword")}
          />
          <p className="text-red-600">{form.formState.errors.confirmPassword?.message?.toString()}</p>
        </div>
        <Button disabled={formState.isLoading} className="w-full">
          {formState.isLoading && (
            <Icons.spinner className="mr-2 h-4 w-4 animate-spin" />
          )}
          Register with Email
        </Button>
      </form>
    </div>
  )
}

export function UserAuthForm({ mode, formState, className, ...props }: UserAuthFormProps) {
  return (
    <>
      {mode === "login" ? (
        <UserLoginAuthForm mode={"login"} formState={formState} className={className} {...props} />
      ) : (
        <UserRegisterAuthForm mode={"register"} formState={formState} className={className} {...props} />
      )}
    </>
  )
}
